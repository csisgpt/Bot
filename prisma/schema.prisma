generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Signal {
  id         String       @id @default(uuid())
  source     SignalSource @default(BINANCE)
  assetType  String
  instrument String
  interval   String
  strategy   String
  kind       String
  side       String
  time       DateTime
  price      Float?
  confidence Int
  tags       String[]
  reason     String
  why        String?
  indicators Json?
  levels     Json?
  sl         Float?
  tp1        Float?
  tp2        Float?
  externalId String?
  dedupKey   String?
  rawPayload Json?
  createdAt  DateTime @default(now())

  @@index([assetType, instrument, interval, time])
  @@index([externalId])
  @@unique([dedupKey])
  @@index([createdAt])
}

model ChatConfig {
  id                String   @id @default(uuid())
  chatId            String   @unique
  chatType          ChatType
  title             String?
  isEnabled         Boolean  @default(true)
  assetsEnabled     String[] @default([])
  timeframes        String[] @default([])
  watchlist         String[] @default([])
  mode              String   @default("NORMAL")
  enabledProviders  String[] @default([])
  enabledFeatures   Json     @default("{\"signals\":true,\"news\":true,\"arbitrage\":true}")
  minConfidence     Int      @default(60)
  quietHoursEnabled Boolean  @default(true)
  quietHoursStart   String   @default("23:00")
  quietHoursEnd     String   @default("08:00")
  maxNotifsPerHour  Int      @default(12)
  cooldownSignalsSec Int     @default(600)
  cooldownNewsSec   Int      @default(1800)
  cooldownArbSec    Int      @default(300)
  digestEnabled     Boolean  @default(false)
  digestTimes       String[] @default([])
  sendToGroup       Boolean  @default(true)
  sendToChannel     Boolean  @default(false)
  mutedUntil        DateTime?
  mutedInstruments  String[] @default([])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([chatType])
}

model AlertRule {
  id         String        @id @default(uuid())
  userId     String
  chatId     String
  instrument String
  type       AlertRuleType
  threshold  Float?
  basePrice  Float?
  isActive   Boolean       @default(true)
  expiresAt  DateTime?
  createdAt  DateTime      @default(now())

  @@index([userId])
  @@index([chatId])
  @@index([instrument])
  @@index([expiresAt])
}

model SignalDeliveryLog {
  id        String         @id @default(uuid())
  signalId  String
  chatId    String
  messageId String
  status    DeliveryStatus
  error     String?
  createdAt DateTime       @default(now())

  @@index([signalId])
  @@index([chatId])
}

model SignalFeedback {
  id        String   @id @default(uuid())
  signalId  String
  userId    String
  value     Int
  createdAt DateTime @default(now())

  @@unique([signalId, userId])
  @@index([signalId])
}

model Candle {
  id         String   @id @default(uuid())
  source     String
  assetType  String
  instrument String
  timeframe  String
  time       DateTime
  open       Float
  high       Float
  low        Float
  close      Float
  volume     Float?
  rawPayload Json?
  createdAt  DateTime @default(now())

  @@unique([source, instrument, timeframe, time])
  @@index([source, instrument, timeframe, time])
  @@index([instrument, timeframe, time])
}

model MarketCandle {
  id              String   @id @default(uuid())
  provider        String
  canonicalSymbol String
  timeframe       String
  openTime        DateTime
  open            Float
  high            Float
  low             Float
  close           Float
  volume          Float
  isFinal         Boolean  @default(true)
  rawPayload      Json?
  createdAt       DateTime @default(now())

  @@unique([provider, canonicalSymbol, timeframe, openTime])
  @@index([canonicalSymbol, timeframe, openTime])
}

model News {
  id         String   @id @default(uuid())
  provider   String
  ts         DateTime
  title      String
  url        String
  category   String
  tags       String[]
  hash       String   @unique
  rawPayload Json?
  createdAt  DateTime @default(now())

  @@index([provider, ts])
}

model ArbOpportunity {
  id              String   @id @default(uuid())
  canonicalSymbol String
  ts              DateTime
  kind            String
  buyExchange     String
  sellExchange    String
  buyPrice        Float
  sellPrice       Float
  spreadAbs       Float
  spreadPct       Float
  netPct          Float?
  confidence      Int
  reason          String
  dedupKey        String   @unique
  createdAt       DateTime @default(now())

  @@index([canonicalSymbol, ts])
}

model SignalProcessingState {
  id                      String   @id @default(uuid())
  source                  String
  instrument              String
  timeframe               String
  strategy                String
  lastProcessedCandleTime DateTime
  updatedAt               DateTime @updatedAt

  @@unique([source, instrument, timeframe, strategy])
  @@index([source, instrument, timeframe, strategy])
}

model SignalDelivery {
  id                String   @id @default(uuid())
  signalId          String
  chatId            String
  deliveredAt       DateTime @default(now())
  providerMessageId String?

  @@unique([signalId, chatId])
  @@index([chatId, deliveredAt])
}

model NotificationDelivery {
  id                String   @id @default(uuid())
  entityType        String
  entityId          String
  chatId            String
  status            String   @default("SENT")
  reason            String?
  providerMessageId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([entityType, entityId, chatId])
  @@index([chatId, createdAt])
}

enum SignalSource {
  BINANCE
  TRADINGVIEW
}

enum AlertRuleType {
  UP_PCT
  DOWN_PCT
  TP1
}

enum DeliveryStatus {
  SENT
  FAILED
}

enum ChatType {
  private
  group
  channel
}
