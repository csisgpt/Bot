# PR4.1: ارکستریتور اعلان‌ها
این ارکستریتور، ارسال اعلان‌های سیگنال، خبر و آربیتراژ را در یک مسیر واحد تجمیع می‌کند تا:
- سیاست‌های هر چت اعمال شود (مود، واچ‌لیست، ارائه‌دهنده، ساعات سکوت، نرخ و کولداون)
- ثبت‌های قابل پیگیری در دیتابیس داشته باشیم (NotificationDelivery)
## سیاست‌ها و مودها
  - NORMAL: تعادل معمولی
  - FOCUS: سخت‌گیرانه‌تر (اعتماد بالاتر، کولداون بیشتر، سقف کمتر)
  - SLEEP: بسیار سخت‌گیرانه (فقط موارد خیلی مهم)
- **واچ‌لیست:** اگر خالی نباشد، فقط نمادهای موجود ارسال می‌شوند.
- **فیلتر ارائه‌دهنده:** اگر لیست خالی نباشد، فقط همان ارائه‌دهنده‌ها مجازند.
  - سیگنال فقط با اعتماد ‌≥‌85
  - آربیتراژ فقط اگر سود خالص ‌≥‌0.5٪
- **کول‌داون:** جلوگیری از تکرار پشت‌سرهم برای هر نوع اعلان.
- **دایجست:** اعلان‌های کم‌اولویت بافر می‌شوند و در زمان‌های مشخص خلاصه ارسال می‌شود.

## رفتار بافر/اسکیپ
- اگر `digestEnabled=true` باشد، اعلان‌های کم‌اولویت **BUFFERED** می‌شوند.
- اگر `digestEnabled=false` باشد:
  - `quiet_hours` و `rate_limit` فعلاً **SKIPPED** می‌شوند (بدون بافر).
  - `cooldown`، `min_confidence` و فیلترهای واچ‌لیست/ارائه‌دهنده نیز **SKIPPED** هستند.

> یادداشت: در نسخه‌های بعدی امکان «تعویق ارسال» برای `quiet_hours` و `rate_limit` بررسی می‌شود.
مقادیر `quietHoursStart/End` بر اساس `APP_TIMEZONE` تفسیر می‌شوند.
به‌طور پیش‌فرض `Europe/Berlin` است و از ساعت محلی استفاده می‌کند.
1. مایگریشن‌ها را اعمال کنید:
3. تست‌های واحد:
## نکته‌های پیاده‌سازی
- ارسال‌ها همیشه از مسیر ارکستریتور عبور می‌کنند.
- پیام‌ها با HTML امن ساخته می‌شوند تا خطای «can't parse entities» رخ ندهد.
## ساعات سکوت و منطقه زمانی
مقادیر `quietHoursStart/End` بر اساس `APP_TIMEZONE` تفسیر می‌شوند.
به‌طور پیش‌فرض `Europe/Berlin` است و از ساعت محلی استفاده می‌کند.
این ارکستریتور، ارسال اعلان‌های سیگنال، خبر و آربیتراژ را در یک مسیر واحد تجمیع می‌کند تا:
- سیاست‌های هر چت اعمال شود (مود، نرخ، سکوت، واچ‌لیست)
- ثبت‌های قابل پیگیری در دیتابیس داشته باشیم (NotificationDelivery)
## سیاست‌ها و مودها
  - AGGRESSIVE: محدودیت کمتر و حداقل اعتماد پایین‌تر
- **واچ‌لیست:** اگر خالی نباشد، فقط نمادهای موجود ارسال می‌شوند.
- **فیلتر ارائه‌دهنده:** اگر لیست خالی نباشد، فقط همان ارائه‌دهنده‌ها مجازند.
  - سیگنال فقط با اعتماد ‌≥‌85
  - آربیتراژ فقط اگر سود خالص ‌≥‌0.5٪
- **کول‌داون:** جلوگیری از تکرار پشت‌سرهم برای هر نوع اعلان.
1. مایگریشن‌ها را اعمال کنید:
3. تست‌های واحد:
## نکته‌های پیاده‌سازی
- ارسال‌ها همیشه از مسیر ارکستریتور عبور می‌کنند.
- پیام‌ها با HTML امن ساخته می‌شوند تا خطای «can't parse entities» رخ ندهد.
## سیاستها و مودها
- **مودها:** NORMAL / QUIET / AGGRESSIVE
  - QUIET: محدودیت بیشتر و حداقل اعتماد بالاتر
  - AGGRESSIVE: محدودیت کمتر و حداقل اعتماد پایینتر
- **واچلیست:** اگر خالی نباشد، فقط نمادهای موجود ارسال میشوند.
- **فیلتر ارائهدهنده:** اگر لیست خالی نباشد، فقط همان ارائهدهندهها مجازند.
- **ساعات سکوت:**
  - سیگنال فقط با اعتماد ≥85
  - خبر فقط اگر مهم/اعلان باشد
  - آربیتراژ فقط اگر سود خالص ≥0.5٪
- **محدودیت نرخ:** حداکثر اعلان در هر ساعت برای هر چت.
- **کولداون:** جلوگیری از تکرار پشتسرهم برای هر نوع اعلان.

## کلیدهای محیطی
```env
NOTIFICATION_ORCHESTRATOR_ENABLED=true
NOTIF_MODE_DEFAULT=NORMAL
NOTIF_MAX_PER_HOUR_DEFAULT=12
NOTIF_QUIET_HOURS_DEFAULT_ENABLED=true
NOTIF_QUIET_HOURS_DEFAULT_START=23:00
NOTIF_QUIET_HOURS_DEFAULT_END=08:00
NOTIF_COOLDOWN_SIGNALS_DEFAULT=600
NOTIF_COOLDOWN_NEWS_DEFAULT=1800
NOTIF_COOLDOWN_ARB_DEFAULT=300
NOTIF_MIN_CONFIDENCE_DEFAULT=60
NOTIF_DIGEST_ENABLED_DEFAULT=false
NOTIF_DIGEST_TIMES_DEFAULT=09:00,21:00
```

## نحوه تست محلی
1. مایگریشنها را اعمال کنید:
   ```bash
   pnpm prisma migrate deploy
   ```
2. Worker را اجرا کنید و سپس:
   - سیگنال/خبر/آربیتراژ جدید بسازید
   - خروجی /health/notifications را بررسی کنید
3. تستهای واحد:
   ```bash
   pnpm test -- notification-policy
   ```

## نکتههای پیادهسازی
- جدول `NotificationDelivery` منبع حقیقت تحویل است.
- ارسالها همیشه از مسیر ارکستریتور عبور میکنند.
- پیامها با HTML امن ساخته میشوند تا خطای «can't parse entities» رخ ندهد.
