# PR1: زیربنای داده‌های بازار

## هدف
این سند توضیح می‌دهد که زیربنای داده‌های بازار چگونه پیاده‌سازی شده و چه پرچم‌های محیطی برای اجرا لازم است. تمرکز روی دریافت قیمت، ذخیره‌سازی کندل‌ها و تجمیع آن‌ها است.

## اجزا و نقش‌ها
- **Binance WebSocket**: آخرین قیمت را در ردیس ذخیره می‌کند تا به‌صورت سریع در دسترس باشد.
- **Candle Ingest**: کندل‌های ۱ دقیقه‌ای را از Binance دریافت کرده و در دیتابیس ذخیره می‌کند.
- **Candle Aggregate**: کندل‌های ۱ دقیقه‌ای را به تایم‌فریم‌های بالاتر (۵m و ۱۵m) تجمیع می‌کند.
- **Monitoring Plan**: نمادها و تایم‌فریم‌های فعال را از تنظیمات چت‌ها و متغیرهای محیطی می‌سازد.

## کلیدهای ردیس
- `md:price:last:BINANCE:<SYMBOL>` آخرین قیمت نماد در Binance
- `md:active:symbols` آرایه‌ی JSON از نمادهای فعال برای مشاهده و دیباگ

> کلید قدیمی `price:last:<SYMBOL>` فقط برای خواندن پشتیبانی می‌شود تا مهاجرت بدون خطا باشد.

## جدول Candle
- `source` منبع داده (مثلاً `BINANCE`)
- `assetType` نوع دارایی (مثل `CRYPTO` یا `GOLD`)
- `instrument` نماد استاندارد
- `timeframe` تایم‌فریم کندل
- `time` زمان بازشدن کندل
- `open/high/low/close` مقادیر قیمت
- `volume` حجم (اختیاری)
- `rawPayload` داده‌ی خام یا اطلاعات تجمیع

## متغیرهای محیطی مهم
- `PRICE_INGEST_ENABLED` فعال/غیرفعال کردن دریافت قیمت از WS
- `PRICE_CACHE_TTL_SECONDS` زمان انقضای کش قیمت (ثانیه)
- `UNIVERSE_DEFAULT_SYMBOLS` لیست پیش‌فرض نمادها (CSV)
- `UNIVERSE_MAX_SYMBOLS` سقف تعداد نمادهای فعال
- `DEFAULT_TIMEFRAMES` تایم‌فریم‌های پیش‌فرض پایش
- `CANDLE_INGEST_ENABLED` فعال/غیرفعال کردن اینجست کندل
- `CANDLE_INGEST_INTERVAL_SECONDS` فاصله اجرای اینجست (ثانیه)
- `CANDLE_INGEST_CONCURRENCY` هم‌زمانی اینجست
- `CANDLE_AGGREGATE_ENABLED` فعال/غیرفعال کردن تجمیع
- `AGG_TIMEFRAMES` تایم‌فریم‌های تجمیع (CSV)

## اجرای محلی
1. دیتابیس و ردیس را راه‌اندازی کنید.
2. متغیرهای محیطی را در `.env` تنظیم کنید.
3. مهاجرت پایگاه داده را اجرا کنید:
   - `pnpm prisma migrate deploy`
4. Worker را اجرا کنید:
   - `pnpm --filter worker start:dev`

## چک‌لیست تست دستی
- [ ] بررسی اتصال WS و وجود کلید `md:price:last:BINANCE:<SYMBOL>` در ردیس
- [ ] بررسی ایجاد رکوردهای ۱ دقیقه‌ای در جدول `Candle`
- [ ] بررسی تجمیع ۵m/۱۵m و وجود کندل‌های جدید
- [ ] بررسی `GET /health/market-data` برای مشاهده نمونه وضعیت
